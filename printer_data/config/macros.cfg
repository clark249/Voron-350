####################################################################################

[gcode_macro PRINT_START]
gcode:
  # This part fetches data from your slicer. Such as bed temp, extruder temp, chamber temp and size of your printer.
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  #{% set target_chamber = params.CHAMBER|default("40")|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}
  
  ##################################################################################################################################### 
  SET_GCODE_OFFSET Z=0.280   
  #####################################################################################################################################
  
  # Homes the printer, sets absolute positioning and updates the Stealthburner leds.
  #STATUS_HOMING         # Sets SB-leds to homing-mode
  G28 X
  G28 Y
  G28 Z                 # Full home (XYZ)
  G90                   # Absolut position

  ##  Uncomment for bed mesh (1 of 2)
  BED_MESH_CLEAR       # Clears old saved bed mesh (if any)

  # Checks if the bed temp is higher than 90c - if so then trigger a heatsoak.
  {% if params.BED|int > 90 %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Displays info
    #STATUS_HEATING                                      # Sets SB-leds to heating-mode
    M106 S255                                           # Turns on the PT-fan

    ##  Uncomment if you have a Nevermore.
    #SET_PIN PIN=nevermore VALUE=1                      # Turns on the nevermore

    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Goes to center of the bed
    M190 S{target_bed}                                  # Sets the target temp for the bed
    SET_DISPLAY_TEXT MSG="Heatsoak: {target_chamber}c"  # Displays info
    #TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber}   # Waits for chamber to reach desired temp

  # If the bed temp is not over 90c, then it skips the heatsoak and just heats up to set temp with a 5min soak
  {% else %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Displays info
    #STATUS_HEATING                                      # Sets SB-leds to heating-mode
    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Goes to center of the bed
    M190 S{target_bed}                                  # Sets the target temp for the bed
    SET_DISPLAY_TEXT MSG="Soak for 3min"                # Displays info
    G4 P180000                                          # Waits 3 min for the bedtemp to stabilize
  {% endif %}

  # Heating nozzle to 150 degrees. This helps with getting a correct Z-home
  #SET_DISPLAY_TEXT MSG="Hotend: 150c"          # Displays info
  #M109 S150                                    # Heats the nozzle to 150c

  ##  Uncomment for Trident (Z_TILT_ADJUST)
  #SET_DISPLAY_TEXT MSG="Z-tilt adjust"     # Displays info
  #STATUS_LEVELING                          # Sets SB-leds to leveling-mode
  Z_TILT_ADJUST                            # Levels the buildplate via z_tilt_adjust
  G28 Z                                    # Homes Z again after z_tilt_adjust

  ##  Uncomment for V2 (Quad gantry level AKA QGL)
  #SET_DISPLAY_TEXT MSG="QGL"      # Displays info
  #STATUS_LEVELING                 # Sets SB-leds to leveling-mode
  #quad_gantry_level               # Levels the buildplate via QGL
  #G28 Z                           # Homes Z again after QGL

  ##  Uncomment for Klicky auto-z
  #CALIBRATE_Z                                 # Calibrates Z-offset with klicky
  #SET_DISPLAY_TEXT MSG="Z-offset"             # Displays info

  ##  Uncomment for bed mesh (2 of 2)
  SET_DISPLAY_TEXT MSG="Bed mesh"    # Displays info
  #STATUS_MESHING                     # Sets SB-leds to bed mesh-mode
  bed_mesh_calibrate                 # Starts bed mesh

  BED_MESH_PROFILE LOAD="default"

  # Heats up the nozzle up to target via data from slicer
  SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"             # Displays info
  #STATUS_HEATING                                                # Sets SB-leds to heating-mode
  G1 X{x_wait} Y{y_wait} Z15 F9000                              # Goes to center of the bed
  M107                                                          # Turns off partcooling fan
  M109 S{target_extruder}                                       # Heats the nozzle to printing temp

# Call the clean_nozzle macro
  clean_nozzle

  # Gets ready to print by doing a purge line and updating the SB-leds
  SET_DISPLAY_TEXT MSG="Printer goes brr"          # Displays info
  #STATUS_PRINTING                                  # Sets SB-leds to printing-mode
  G0 X{x_wait - 50} Y10 F10000                      # Moves to starting point
  G0 Z0.4                                          # Raises Z to 0.4
  G91                                              # Incremental positioning 
  G1 X100 E20 F1000                                # Purge line
  G90                                              # Absolut position


##################################################################################################################################### 
  SKEW_PROFILE LOAD=CaliFlower   
#####################################################################################################################################


##################################################################################################################################### 
#####################################################################################################################################
#################################                 End of Start Macro               ################################################## 
#####################################################################################################################################
##################################################################################################################################### 


##################################################################################################################################### 
#####################################################################################################################################
#################################                   Print End Macro                ################################################## 
#####################################################################################################################################
#####################################################################################################################################

[gcode_macro PRINT_END]
gcode:
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
##################################################################################################################################### 
     SET_SKEW CLEAR=1  
#####################################################################################################################################

    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-20.0 F3600                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    SET_FAN_SPEED FAN=fan0 SPEED=0
    SET_FAN_SPEED FAN=fan2 SPEED=0
    SET_FAN_SPEED FAN=fan3 SPEED=0

    
    BED_MESH_CLEAR

    # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
    # command pair is to restore the printer's coordinate system
    # and speed settings since the commands above change them.
    # However, to prevent any accidental, unintentional toolhead
    # moves when restoring the state, explicitly set MOVE=0.
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0

    
#########################################################################################################
##                  Pause
#########################################################################################################

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
# change this if you need more or less extrusion
variable_extrude: 1.0
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  PAUSE_BASE
  G91
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    G1 Z{z_safe} F900
    G90
    G1 X45 Y55 F6000
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %} 



#########################################################################################################
##                  Resume
#########################################################################################################

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  #### get VELOCITY parameter if specified ####
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}  
  RESUME_BASE {get_params}

  
#########################################################################################################
##                  Cancel Print
#########################################################################################################

[gcode_macro CANCEL_PRINT]
# Defines a G-code macro to cancel the actual running print
description = Cancel the actual running print
rename_existing = CANCEL_PRINT_BASE
variable_park = True
gcode = 
    G28 Y                                     # Home Y axis
    _TOOLHEAD_PARK_PAUSE_CANCEL               # Call _TOOLHEAD_PARK_PAUSE_CANCEL macro
    TURN_OFF_HEATERS                          # Turn off all heaters
    CANCEL_PRINT_BASE                         # Call CANCEL_PRINT_BASE to cancel print
    SET_FAN_SPEED FAN=fan0 SPEED=0
    SET_FAN_SPEED FAN=fan2 SPEED=0
    SET_FAN_SPEED FAN=fan3 SPEED=0



#########################################################################################################
##                  Save State
#########################################################################################################

[gcode_macro SAVE_GCODE_STATE]
rename_existing: SAVE_GCODE_STATE_BASE
gcode:
    SAVE_GCODE_STATE_BASE {rawparams}

[gcode_macro RESTORE_GCODE_STATE]
rename_existing: RESTORE_GCODE_STATE_BASE
gcode:
    RESTORE_GCODE_STATE_BASE {rawparams}





#####################################################################
##                  M106
#####################################################################

[gcode_macro M106]
gcode:
    {% set fan = 'fan' + (params.P|int if params.P is defined else 0)|string %}
    {% set speed = (params.S|float / 255 if params.S is defined else 1.0) %}
    SET_FAN_SPEED FAN={fan} SPEED={speed}


####################################################################################
##                                    Homing Override
####################################################################################
#[homing_override]
#axes: z                    # Override homing for the Z axis only
#set_position_z: 0           # Set the Z position to 0 after homing
#gcode:
    #G90                     # Set to absolute positioning mode
    #G0 Z10 F1200            # Move Z axis to 10mm above the bed at 1200 mm/min
   # G28 Y                   # Home Y axis
   # G28 X                   # Home X axis
    #G1 X175 Y175 F7200      # Move to a specific coordinate (125, 125) at 7200 mm/min
    #G28 Z                   # Home Z axis again

####################################################################################
##                                    Z Tilt Adjustment
####################################################################################
[z_tilt]
##  Use Z_TILT_ADJUST to level the bed.
##  z_positions: Location of toolhead
z_positions:
   #-50, 18
   50, 18
   175, 396
   396, 18
points:
   50, 50
   175, 300
   300, 50
##--------------------------------------------------------------------

speed: 350                 # Speed of Z tilt adjustment
horizontal_move_z: 2       # Z axis move speed for adjustments
retries: 10                # Number of retries for adjustment points
#retry_tolerance: 0.0075    # Retry tolerance for adjustment accuracy
retry_tolerance: 0.01    # Retry tolerance for adjustment accuracy
####################################################################################
####################################################################################

#########################################################################################################
##                  Z-Tilt Adjust
#########################################################################################################

[gcode_macro Z_TILT_ADJUST]     # IDM/Cartographer optimized 3Z leveling macro
rename_existing: _Z_TILT_ADJUST
gcode:
    SAVE_GCODE_STATE NAME=STATE_Z_TILT         # Save current state for Z tilt adjustment
    BED_MESH_CLEAR                             # Clear bed mesh
    {% if not printer.z_tilt.applied %}
      _Z_TILT_ADJUST horizontal_move_z=10 retry_tolerance=1   # Adjust Z tilt with higher tolerance initially
    {% endif %}
    _Z_TILT_ADJUST horizontal_move_z=2          # Fine-tune Z tilt adjustment
    RESTORE_GCODE_STATE NAME=STATE_Z_TILT       # Restore saved state after adjustment



#########################################################################################################
##                  Load Filament
#########################################################################################################

[gcode_macro LOAD_FILAMENT]
variable_load_distance:  50
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0
    G1 E{load_distance} F{max_velocity} # fast-load
    G1 E{purge_distance} F{speed} # purge
    RESTORE_GCODE_STATE NAME=load_state



#########################################################################################################
##                  Unload Filament
#########################################################################################################

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  50
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0
    G1 E{purge_distance} F{speed} # purge
    G1 E-{unload_distance} F{max_velocity} # fast-unload
    RESTORE_GCODE_STATE NAME=unload_state

####################################################################################
##                               Probe Calibration Macro
####################################################################################




#########################################################################################################
##                  Bed Leveling and Height Calibration Macro
#########################################################################################################

[gcode_macro G32]
# Defines a G-code macro for bed leveling and height calibration
gcode:
    BED_MESH_CLEAR               # Clear bed mesh
    G28                          # Home all axes
    Z_TILT_ADJUST                # Perform gantry leveling
    G28                          # Home all axes
    G0 X175 Y175 Z30 F3600       # Fast move to X150 Y150 Z30 at 3600 mm/min



#########################################################################################################
##                  Draw Lines
#########################################################################################################

[gcode_macro DRAW_LINES]
gcode:
    G90                           # Absolute positioning
    # G92 E0                      # Reset Extruder (commented out for now)
    # G1 Z5.0  F7200              # Move Z Axis up (commented out for now)
    G1 X50  Y0         F7200      # Move to start position
    M83                           # Set extruder to relative mode
    G1 E15 F400                   # Extrude filament
    G1 Z0.28 F7200                # Lower Z axis
    G1 X200 Y0   Z0.28 F1200 E17  # Draw the first line
    G1 X200 Y0.4 Z0.28 F2400      # Move to side a little
    G1 X55  Y0.4 Z0.28 F1200 E34  # Draw the second line
    G92 E0                        # Reset Extruder
    G90                           # Return to absolute positioning


#########################################################################################################
##                  Hot Pull
#########################################################################################################


[gcode_macro HOT_PULL]
gcode:
    # Set the desired temperature for the hot pull
    {% set hot_temp = params.HOT_TEMP|default(240)|int %}
    
    # Save the current state
    SAVE_GCODE_STATE NAME=HOT_PULL_STATE

    # Heat up and wait
    M117 Heating for hot pull...
    M109 S{hot_temp}

    # Signal the user to push the filament
    M117 Insert and extrude filament, then confirm.
    RESPOND TYPE=prompt MSG="Insert filament, extrude a bit, then proceed."

    # Pause until user confirms
    PAUSE

    # Signal the user to perform the pull
    M117 Hot pull! Quickly pull the filament.
    RESPOND TYPE=prompt MSG="Pull the filament quickly and firmly."
    
    # Wait for the user to pull the filament
    PAUSE

    # Restore the saved state
    RESTORE_GCODE_STATE NAME=HOT_PULL_STATE

    M117 Hot pull complete.

#########################################################################################################
##                  Cold Pull
#########################################################################################################



    [gcode_macro COLD_PULL]
gcode:
    # Set temperatures for the cold pull procedure
    {% set melt_temp = params.MELT_TEMP|default(240)|int %}
    {% set pull_temp = params.PULL_TEMP|default(100)|int %}

    # Save the current state
    SAVE_GCODE_STATE NAME=COLD_PULL_STATE

    # Heat up and wait
    M117 Heating for cold pull...
    M109 S{melt_temp}

    # Signal user and wait for filament insertion
    M117 Insert and push filament, then confirm.
    RESPOND TYPE=prompt MSG="Insert filament, push down, and proceed."

    # Pause until user confirms
    PAUSE

    # Cool down to pull temperature
    M117 Cooling to pull temperature...
    M104 S{pull_temp}
    TEMPERATURE_WAIT S={pull_temp}

    # Signal user to perform the pull
    M117 Cold pull! Pull the filament quickly.
    RESPOND TYPE=prompt MSG="Pull the filament quickly and firmly."
    
    # Wait for the user to pull the filament
    PAUSE

    # Restore the saved state
    RESTORE_GCODE_STATE NAME=COLD_PULL_STATE

    M117 Cold pull complete.

#########################################################################################################
##                  Filament Cleaning (HOt and Cold)
#########################################################################################################



[gcode_macro FILAMENT_CLEANING]
gcode:
    # Check if a pull type is specified
    {% if not 'TYPE' in params %}
        RESPOND TYPE=error MSG="Invalid usage. Use FILAMENT_CLEANING TYPE=HOT or FILAMENT_CLEANING TYPE=COLD"
    {% elif params.TYPE == 'HOT' %}
        HOT_PULL {rawparams}
    {% elif params.TYPE == 'COLD' %}
        COLD_PULL {rawparams}
    {% else %}
        RESPOND TYPE=error MSG="Invalid pull type specified. Use TYPE=HOT or TYPE=COLD"
    {% endif %}



