
[include ServiceSettings.cfg]
[respond]

[gcode_macro Service_Position]
gcode:
    {% set Service_settings = printer["gcode_macro Service_settings"] %}
    {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
    {% set z_center = (printer.toolhead.axis_minimum.z|float + printer.toolhead.axis_maximum.z|float ) / 2 %}
    {% set leds = Service_settings.leds | abs %}
    {% set cold_swap_hotend = Service_settings.cold_swap_hotend| abs %}
    {% set retract_distance = Service_settings.retract_distance | float %}
    {% set retract_temp = Service_settings.retract_temp | float %}
    {% set nozzle_swap_temp = Service_settings.nozzle_swap_temp | float %}
    
    _Smart_Homing
    SAVE_GCODE_STATE NAME=SERVICE_STATE
    RESPOND TYPE=command MSG="action:prompt_begin Service Mode"
    RESPOND TYPE=command MSG="action:prompt_text Return To last position?"
    RESPOND TYPE=command MSG="action:prompt_button Nozzle Swap|_NOZZLE_CHANGE|warning"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_Prompt2|info"
    RESPOND TYPE=command MSG="action:prompt_button  No|RESPOND TYPE=command MSG=action:prompt_end|error"
    RESPOND TYPE=command MSG="action:prompt_show"
     {% if leds == True %}
        status_busy
    {% endif %}

    G0 X{x_center} Y25 Z{z_center}
    
[gcode_macro _NOZZLE_CHANGE]
gcode:
    {% set Service_settings = printer["gcode_macro Service_settings"] %}
    {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
    {% set z_center = (printer.toolhead.axis_minimum.z|float + printer.toolhead.axis_maximum.z|float ) / 2 %}
    {% set leds = Service_settings.leds | abs %}
    {% set cold_swap_hotend = Service_settings.cold_swap_hotend| abs %}
    {% set retract_distance = Service_settings.retract_distance | float %}
    {% set retract_temp = Service_settings.retract_temp | float %}
    {% set nozzle_swap_temp = Service_settings.nozzle_swap_temp | float %}
    
    {% if leds == True %}
      status_heating
    {% endif %}
    
    {% if cold_swap_hotend == True %}
        _cold_nozzle

    {% else %}
        _hot_nozzle

    {% endif %}
    
[gcode_macro _hot_nozzle]
gcode:
    {% set Service_settings = printer["gcode_macro Service_settings"] %}
    {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
    {% set z_center = (printer.toolhead.axis_minimum.z|float + printer.toolhead.axis_maximum.z|float ) / 2 %}
    {% set leds = Service_settings.leds | abs %}
    {% set cold_swap_hotend = Service_settings.cold_swap_hotend| abs %}
    {% set retract_distance = Service_settings.retract_distance | float %}
    {% set retract_temp = Service_settings.retract_temp | float %}
    {% set nozzle_swap_temp = Service_settings.nozzle_swap_temp | float %}
    
    RESPOND TYPE=command MSG=action:prompt_end
    
    M118 Heating up the nozzle
    M104 S{Service_settings.nozzle_swap_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={Service_settings.nozzle_swap_temp}

    M118 Retracting Filament....
    G4 P1000
    G91                                        #Set relative positioning for extrusion
    G92 E0                                     #Reset extruder position
    _Retract
    G4 P3000
    
    RESPOND TYPE=command MSG=action:prompt_end
    RESPOND TYPE=command MSG="action:prompt_begin Swap the Nozzle!"
    RESPOND TYPE=command MSG="action:prompt_text Nozzle swap complete?"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_Complete|info"
    RESPOND TYPE=command MSG="action:prompt_button Retract|_Retract|info"
    RESPOND TYPE=command MSG="action:prompt_button Extrude|_Extrude|error"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _cold_nozzle]
gcode:
    {% set Service_settings = printer["gcode_macro Service_settings"] %}
    {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
    {% set z_center = (printer.toolhead.axis_minimum.z|float + printer.toolhead.axis_maximum.z|float ) / 2 %}
    {% set leds = Service_settings.leds | abs %}
    {% set cold_swap_hotend = Service_settings.cold_swap_hotend| abs %}
    {% set retract_distance = Service_settings.retract_distance | float %}
    {% set retract_temp = Service_settings.retract_temp | float %}
    {% set nozzle_swap_temp = Service_settings.nozzle_swap_temp | float %}
    {% set cold_swap_temp = Service_settings.cold_swap_temp | float %}

    RESPOND TYPE=command MSG=action:prompt_end

    M118 Heating Up The Nozzle To Retract Filament...
    
    M104 S{Service_settings.retract_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={Service_settings.retract_temp}
    

    M118 Retracting Filament....

    G4 P1000
    G91                                 #Set relative positioning for extrusion
    G92 E0                               #Reset extruder position
    _Retract
    G4 P5000
    M104 S0

    {% if leds == True %}
      status_cooling
    {% endif %}

    M118 Cooling Down... Please Wait
    M106 S255  
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={cold_swap_temp}
    M106 S0
    RESPOND TYPE=command MSG="action:prompt_begin Swap the Nozzle!"
    RESPOND TYPE=command MSG="action:prompt_text Nozzle swap complete?"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_Complete|info"
    RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro _Smart_Homing]
gcode:
    {% if printer.toolhead.homed_axes == "xyz" %}
        M118 Printer is already homed
    {% else %}
        M118 Printer Homing...
        G28
    {% endif %}
        
    
[gcode_macro _Complete]
gcode:
    {% set Service_settings = printer["gcode_macro Service_settings"] %}
    {% set cold_swap_hotend = Service_settings.cold_swap_hotend| abs %}
    {% set leds = Service_settings.leds | abs %}
    
    G1 E0                                          #Unretract Filament
    G90                                            #Reset to Absolute positioning
    RESTORE_GCODE_STATE NAME=SERVICE_STATE MOVE=1
    {% if cold_swap_hotend == False %}
      M104 S0                                      #Turn Heater off
    {% endif %}
                                
    RESPOND TYPE=command MSG=action:prompt_end
    
    {% if leds == True %}
          STOP_LED_EFFECTS
          SET_LED_EFFECT EFFECT=rainbow
    {% endif %}

  M118 Nozzle Change Complete!

[gcode_macro _Prompt2]
gcode:
    {% set Service_settings = printer["gcode_macro Service_settings"] %}
    {% set leds = Service_settings.leds | abs %}
    RESTORE_GCODE_STATE NAME=SERVICE_STATE MOVE=1
    RESPOND TYPE=command MSG=action:prompt_end   
    
    {% if leds == True %}
          STOP_LED_EFFECTS
          SET_LED_EFFECT EFFECT=rainbow
    {% endif %}

[gcode_macro _Retract]
gcode:
  {% set Service_settings = printer["gcode_macro Service_settings"] %}
  {% set retract_distance = Service_settings.retract_distance | float %}
  G91                                 #Set relative positioning for extrusion
  G92 E0 
  G1 E-{Service_settings.retract_distance}
  G92 E0
  
[gcode_macro _Extrude]
gcode:
  {% set Service_settings = printer["gcode_macro Service_settings"] %}
  {% set retract_distance = Service_settings.retract_distance | float %}
  G91                                 #Set relative positioning for extrusion
  G92 E0 
  G1 E{Service_settings.retract_distance} F300
  G92 E0

  
  